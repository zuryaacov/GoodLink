# Signup Confirmation Email via Brevo

Instead of Supabase's default confirmation email, the app sends the signup confirmation through **Brevo** (with your templates). The flow:

1. User signs up on the site (email + password).
2. Frontend calls the Worker: `POST /api/send-confirmation-email` with `{ email, redirect_to }`.
3. Worker uses **Supabase Admin API** to generate a confirmation link (`generate_link` type `signup`).
4. Worker sends the email via **Brevo API**, with that link in the template or body.

## Worker (Cloudflare) environment variables

Set these in your Worker (e.g. **Workers & Pages → your worker → Settings → Variables and Secrets**):

| Variable | Required | Description |
|----------|----------|-------------|
| `SUPABASE_URL` | Yes | Supabase project URL (e.g. `https://xxxx.supabase.co`) |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Service role key (Project Settings → API) |
| `BREVO_API_KEY` | Yes | Brevo API key (SMTP/Transactional) from [Brevo → Settings → API Keys](https://app.brevo.com/settings/keys/api) |
| `BREVO_SENDER_EMAIL` | No | Sender email (default: `noreply@goodlink.ai`) |
| `BREVO_SENDER_NAME` | No | Sender name (default: `Goodlink`) |
| `BREVO_CONFIRMATION_SUBJECT` | No | Subject line (default: `Confirm your email - Goodlink`) |
| `BREVO_CONFIRMATION_TEMPLATE_ID` | No | Brevo **template ID** for the confirmation email. If set, the template is used and must include the variables below. |
| `BREVO_CONFIRMATION_HTML` | No | Raw HTML body (used only if no template). Placeholders: `{{CONFIRMATION_LINK}}`, `{{EMAIL}}`. |

### Using a Brevo template

1. In Brevo: **Campaigns → Templates** (or **Transactional → Templates**), create a template.
2. In the template body, add a button or link and use the variable: **`{{ params.CONFIRMATION_LINK }}`** (or the name your template language uses for params).
3. Copy the template ID from the template URL or template settings.
4. Set **`BREVO_CONFIRMATION_TEMPLATE_ID`** in the Worker to that ID.
5. The Worker sends `params: { CONFIRMATION_LINK: "<url>", EMAIL: "<user email>" }`; ensure your template uses these param names.

## Avoiding duplicate emails (Supabase + Brevo)

Right now Supabase may still send its own confirmation email when the user signs up. To send **only** the Brevo email:

- **Option A – Auth Hook (recommended)**  
  In Supabase: **Authentication → Hooks**. Add a "Send Email" or "Sign Up" hook that calls your logic (e.g. your Worker) and, if your plan supports it, skip the default email so only your Brevo send runs.

- **Option B – Custom SMTP**  
  In Supabase: **Project Settings → Auth → SMTP**. Enable "Custom SMTP" and point it to a sink or a no-op so Supabase "sends" but nothing is delivered. Confirmation still works when the user clicks the link in the Brevo email (the link is generated by Supabase Auth).

- **Option C – Rely on Brevo only**  
  Keep "Confirm email" enabled in Supabase so the user stays unconfirmed until they click the link. The link in the Brevo email is the same one Supabase would have sent; if you’ve disabled or broken Supabase’s default send (e.g. via SMTP), only Brevo will send.

## Frontend

The frontend uses **`VITE_WORKER_URL`** (e.g. `https://glynk.to`) to call the Worker. If not set, it defaults to `https://glynk.to`. Set in `.env`:

```env
VITE_WORKER_URL=https://glynk.to
```

(Use your real Worker URL if different.)

## API: `POST /api/send-confirmation-email`

- **Body:** `{ "email": "user@example.com", "redirect_to": "https://yoursite.com/login" }`
- **redirect_to:** Optional. Where to send the user after they click the confirmation link (e.g. `/login?plan=pro`).
- **Response:** `200 { "success": true }` or `4xx/5xx { "error": "..." }`.

The confirmation link is generated by Supabase Auth (`admin/generate_link` type `signup`) and then included in the Brevo email (template or HTML).
