{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "C:\\Users\\User\\Desktop\\\u200F\u200Fgoodlink-p\\goodlink-backend\\.wrangler\\tmp\\deploy-TUJEdJ",
  "sourcesContent": ["/**\r\n * Cloudflare Worker for Link Redirect\r\n * \r\n * This worker:\r\n * 1. Extracts domain from request host\r\n * 2. Extracts slug from URL path\r\n * 3. Queries Supabase for link by slug + domain\r\n * 4. Redirects to target_url if found and active\r\n * \r\n * Environment Variables Required:\r\n * - SUPABASE_URL: Your Supabase project URL\r\n * - SUPABASE_SERVICE_ROLE_KEY: Supabase service role key (bypasses RLS)\r\n * \r\n * Usage:\r\n * GET https://glynk.to/abc123 -> redirects to target_url\r\n */\r\n\r\n/**\r\n * Extract slug from URL path\r\n * @param {string} pathname - URL pathname (e.g., \"/abc123\" or \"/abc123?param=value\")\r\n * @returns {string|null} - Slug or null if invalid\r\n */\r\nfunction extractSlug(pathname) {\r\n    // Remove leading slash and query parameters\r\n    const path = pathname.replace(/^\\//, '').split('?')[0].split('#')[0];\r\n\r\n    // Return null for empty paths or common paths\r\n    if (!path || path === '' || path === 'index.html' || path.startsWith('api/')) {\r\n        return null;\r\n    }\r\n\r\n    // Validate slug format (alphanumeric and hyphens, 3-30 chars)\r\n    const slugPattern = /^[a-z0-9-]{3,30}$/i;\r\n    if (!slugPattern.test(path)) {\r\n        return null;\r\n    }\r\n\r\n    return path.toLowerCase();\r\n}\r\n\r\n/**\r\n * Build target URL with UTM parameters and query string pass-through\r\n * @param {string} targetUrl - Base target URL\r\n * @param {object} linkData - Link data from database\r\n * @param {URL} requestUrl - Original request URL\r\n * @returns {string} - Final URL with all parameters\r\n */\r\nfunction buildTargetUrl(targetUrl, linkData, requestUrl) {\r\n    try {\r\n        const target = new URL(targetUrl);\r\n        const requestParams = new URLSearchParams(requestUrl.search);\r\n\r\n        // Add UTM parameters if configured\r\n        if (linkData.utm_source) {\r\n            target.searchParams.set('utm_source', linkData.utm_source);\r\n        }\r\n        if (linkData.utm_medium) {\r\n            target.searchParams.set('utm_medium', linkData.utm_medium);\r\n        }\r\n        if (linkData.utm_campaign) {\r\n            target.searchParams.set('utm_campaign', linkData.utm_campaign);\r\n        }\r\n        if (linkData.utm_content) {\r\n            target.searchParams.set('utm_content', linkData.utm_content);\r\n        }\r\n\r\n        // Pass through query parameters if enabled\r\n        if (linkData.parameter_pass_through) {\r\n            for (const [key, value] of requestParams.entries()) {\r\n                // Don't override UTM parameters that were just set\r\n                if (!['utm_source', 'utm_medium', 'utm_campaign', 'utm_content'].includes(key)) {\r\n                    target.searchParams.set(key, value);\r\n                }\r\n            }\r\n        }\r\n\r\n        return target.toString();\r\n    } catch (error) {\r\n        // If URL parsing fails, return original target_url\r\n        console.error('Error building target URL:', error);\r\n        return targetUrl;\r\n    }\r\n}\r\n\r\n/**\r\n * Query Supabase for link by slug and domain\r\n * @param {string} slug - Link slug\r\n * @param {string} domain - Domain name\r\n * @param {string} supabaseUrl - Supabase project URL\r\n * @param {string} supabaseKey - Supabase service role key\r\n * @returns {Promise<object|null>} - Link data or null if not found\r\n */\r\nasync function getLinkFromSupabase(slug, domain, supabaseUrl, supabaseKey) {\r\n    try {\r\n        // Use Supabase REST API directly (no client library in Workers)\r\n        // Build query URL with proper encoding\r\n        const queryUrl = `${supabaseUrl}/rest/v1/links?slug=eq.${encodeURIComponent(slug)}&domain=eq.${encodeURIComponent(domain)}&select=target_url,parameter_pass_through,utm_source,utm_medium,utm_campaign,utm_content,status`;\r\n\r\n        console.log(`Querying Supabase: ${queryUrl}`);\r\n        console.log(`Search params: slug=\"${slug}\", domain=\"${domain}\"`);\r\n\r\n        const response = await fetch(queryUrl, {\r\n            method: 'GET',\r\n            headers: {\r\n                'apikey': supabaseKey,\r\n                'Authorization': `Bearer ${supabaseKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Prefer': 'return=representation',\r\n            },\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error(`Supabase query failed: ${response.status} ${response.statusText}`);\r\n            console.error(`Error details: ${errorText}`);\r\n            return null;\r\n        }\r\n\r\n        const data = await response.json();\r\n\r\n        console.log(`Supabase returned ${data?.length || 0} result(s)`);\r\n        if (data && data.length > 0) {\r\n            console.log(`Found link:`, JSON.stringify(data[0], null, 2));\r\n        }\r\n\r\n        if (!data || data.length === 0) {\r\n            console.log(`No link found with slug=\"${slug}\" and domain=\"${domain}\"`);\r\n            // Try to find if there's a link with this slug (for debugging)\r\n            const debugUrl = `${supabaseUrl}/rest/v1/links?slug=eq.${encodeURIComponent(slug)}&select=id,slug,domain,status,target_url`;\r\n            const debugResponse = await fetch(debugUrl, {\r\n                method: 'GET',\r\n                headers: {\r\n                    'apikey': supabaseKey,\r\n                    'Authorization': `Bearer ${supabaseKey}`,\r\n                    'Content-Type': 'application/json',\r\n                },\r\n            });\r\n            if (debugResponse.ok) {\r\n                const debugData = await debugResponse.json();\r\n                if (debugData && debugData.length > 0) {\r\n                    console.log(`Debug: Found ${debugData.length} link(s) with slug \"${slug}\" but different domain:`);\r\n                    debugData.forEach(link => {\r\n                        console.log(`  - id: ${link.id}, domain: \"${link.domain}\", slug: \"${link.slug}\", status: ${link.status !== undefined ? link.status : 'N/A'}`);\r\n                    });\r\n                    // If we found a link with the slug but different domain, try the first one\r\n                    // This handles cases where domain might be stored incorrectly\r\n                    const foundLink = debugData.find(l =>\r\n                        (l.status === undefined || l.status === true) &&\r\n                        l.target_url\r\n                    );\r\n                    if (foundLink) {\r\n                        console.log(`Warning: Using link with domain \"${foundLink.domain}\" instead of requested \"${domain}\"`);\r\n                        return {\r\n                            target_url: foundLink.target_url,\r\n                            parameter_pass_through: true, // Default if not found\r\n                            utm_source: null,\r\n                            utm_medium: null,\r\n                            utm_campaign: null,\r\n                            utm_content: null,\r\n                            status: foundLink.status,\r\n                        };\r\n                    }\r\n                } else {\r\n                    console.log(`Debug: No links found with slug \"${slug}\" at all`);\r\n                }\r\n            } else {\r\n                console.log(`Debug query failed: ${debugResponse.status}`);\r\n            }\r\n            return null;\r\n        }\r\n\r\n        const link = data[0];\r\n\r\n        // Check status if column exists (some databases might not have it yet)\r\n        if (link.status !== undefined && link.status === false) {\r\n            console.log(`Link found but status is false (inactive)`);\r\n            return null; // Link is inactive\r\n        }\r\n\r\n        return link;\r\n    } catch (error) {\r\n        console.error('Error querying Supabase:', error);\r\n        console.error('Error stack:', error.stack);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Main worker handler\r\n */\r\nexport default {\r\n    async fetch(request, env) {\r\n        try {\r\n            // Check for required environment variables\r\n            if (!env.SUPABASE_URL || !env.SUPABASE_SERVICE_ROLE_KEY) {\r\n                console.error('Missing Supabase configuration');\r\n                return new Response('Service configuration error', { status: 500 });\r\n            }\r\n\r\n            const url = new URL(request.url);\r\n            const hostname = url.hostname;\r\n            const pathname = url.pathname;\r\n\r\n            console.log(`Request URL: ${request.url}`);\r\n            console.log(`Hostname: ${hostname}, Pathname: ${pathname}`);\r\n\r\n            // Extract slug from path\r\n            const slug = extractSlug(pathname);\r\n\r\n            console.log(`Extracted slug: ${slug}`);\r\n\r\n            if (!slug) {\r\n                // No valid slug found - return 404\r\n                console.log('No valid slug found in pathname');\r\n                return new Response('Link not found', {\r\n                    status: 404,\r\n                    headers: {\r\n                        'Content-Type': 'text/plain',\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Extract domain from hostname\r\n            // Remove www. prefix if present\r\n            const domain = hostname.replace(/^www\\./, '');\r\n\r\n            console.log(`Looking up link: slug=\"${slug}\", domain=\"${domain}\"`);\r\n\r\n            // Query Supabase for the link\r\n            const linkData = await getLinkFromSupabase(\r\n                slug,\r\n                domain,\r\n                env.SUPABASE_URL,\r\n                env.SUPABASE_SERVICE_ROLE_KEY\r\n            );\r\n\r\n            if (!linkData || !linkData.target_url) {\r\n                // Link not found or inactive\r\n                return new Response('Link not found', {\r\n                    status: 404,\r\n                    headers: {\r\n                        'Content-Type': 'text/plain',\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Build final URL with UTM parameters and query string pass-through\r\n            const finalUrl = buildTargetUrl(linkData.target_url, linkData, url);\r\n\r\n            console.log(`Redirecting to: ${finalUrl}`);\r\n\r\n            // Perform redirect (301 permanent redirect)\r\n            return Response.redirect(finalUrl, 301);\r\n\r\n        } catch (error) {\r\n            console.error('Worker error:', error);\r\n            return new Response('Internal server error', {\r\n                status: 500,\r\n                headers: {\r\n                    'Content-Type': 'text/plain',\r\n                }\r\n            });\r\n        }\r\n    },\r\n};\r\n\r\n"],
  "mappings": "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",
  "names": ["link"]
}
