================================================================================
תכנון: תיקיות (Folders) ללינקים – דומיין + סלאג נשארים כמו היום
================================================================================
מסמך תכנון בלבד – בלי שינוי קוד. מטרה: לאפשר למשתמש לארגן לינקים בתיקיות
(כולל תיקייה בתוך תיקייה), כשהלינקים עצמם נשארים עם domain+slug כרגיל.

--------------------------------------------------------------------------------
1. רמת הטבלאות (Supabase)
--------------------------------------------------------------------------------

1.1 טבלה חדשה: link_folders
   - id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - user_id         UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
   - name            TEXT NOT NULL
   - parent_id       UUID NULL REFERENCES link_folders(id) ON DELETE CASCADE
   - position        INT DEFAULT 0
   - created_at      TIMESTAMPTZ DEFAULT NOW()
   - updated_at      TIMESTAMPTZ DEFAULT NOW()

   הערות:
   - parent_id = NULL = תיקייה ברמת השורש.
   - position = סדר תצוגה (אופציונלי; אפשר גם למיין לפי name).
   - RLS: SELECT/INSERT/UPDATE/DELETE רק כאשר auth.uid() = user_id.
   - אינדקסים: user_id, parent_id (לשליפה מהירה לפי משתמש ולפי הורה).

1.2 שינוי בטבלת links
   - להוסיף עמודה: folder_id UUID NULL REFERENCES link_folders(id) ON DELETE SET NULL
   - folder_id = NULL = לינק לא בתיקייה ("ללא תיקייה").
   - בעת מחיקת תיקייה: ON DELETE SET NULL כדי שהלינקים לא יימחקו, רק ייצאו מהתיקייה.

1.3 אילוצים
   - אין צורך ב־UNIQUE על (user_id, name) או (parent_id, name) אם מאפשרים שמות כפולים
     (למשל "דראפט" תחת תיקיות שונות). אם רוצים שם ייחודי בתוך אותה תיקייה:
     UNIQUE(user_id, parent_id, name) עם nulls not distinct אם parent_id יכול להיות NULL.
   - אין שינוי ב־domain / slug – הלינק מזוהה כרגיל ב־Worker לפי domain+slug.

--------------------------------------------------------------------------------
2. רמת הקוד (Backend / Frontend)
--------------------------------------------------------------------------------

2.1 Supabase – RLS ו־API
   - מדיניות RLS על link_folders:
     - SELECT: auth.uid() = user_id
     - INSERT: auth.uid() = user_id
     - UPDATE: auth.uid() = user_id
     - DELETE: auth.uid() = user_id
   - אין צורך ב־RLS חדש על links מלבד הוספת folder_id; הקריאות הקיימות
     (לפי user_id) נשארות תקפות. אם יש RLS שמגביל לפי user_id – מספיק.

2.2 Worker (link-redirect)
   - ללא שינוי. הניתוב נשאר לפי host → domain ו־path → slug בלבד.
   - תיקיות רלוונטיות רק ל־Dashboard (ארגון ותצוגה).

2.3 Frontend – שירותים ופונקציות
   - fetchFolders(userId):
     - שליפה: link_folders WHERE user_id = userId ORDER BY parent_id NULLS FIRST, position, name.
     - בניית עץ בצד הלקוח: קיבצת תיקיות לפי parent_id (שורש = null).
   - createFolder(userId, { name, parentId?, position? }): INSERT ל־link_folders.
   - updateFolder(folderId, { name?, parentId?, position? }): UPDATE.
   - deleteFolder(folderId): DELETE (לינקים יקבלו folder_id = NULL בגלל ON DELETE SET NULL).
   - fetchLinks(userId, folderId?):
     - אם folderId נתון: .eq('folder_id', folderId).
     - אם "הכל" / ללא תיקייה: .is('folder_id', null) או לא לסנן לפי folder_id.
     - עדיין .eq('user_id', userId), .neq('status', 'deleted').
   - updateLinkFolder(linkId, folderId | null): UPDATE links SET folder_id = ? WHERE id = linkId.

2.4 ולידציה
   - בעת שמירת לינק או שינוי תיקייה: אם folder_id לא null – לוודא שהתיקייה שייכת
     לאותו user_id (למשל שליפה/בדיקה ב־frontend או RPC ב־Supabase).
   - מניעת לולאות: בעת updateFolder(parentId) – לא לאפשר ש־parentId יהיה המזהה של
     התיקייה עצמה או של צאצא שלה (בדיקה ברקורסיה על עץ התיקיות).

--------------------------------------------------------------------------------
3. רמת UI/UX
--------------------------------------------------------------------------------

3.1 Link Manager – מבנה כללי
   - צד שמאל (או פאנל צר): עץ תיקיות.
     - שורש: "כל הלינקים" (או "ללא תיקייה" כשמסננים).
     - מתחתיו רשימת תיקיות; תיקייה עם ילדים – ניתן לפתיחה/סגירה (אקורדיון או עץ).
   - אזור ראשי: רשימת הלינקים בהתאם לתיקייה שנבחרה (או "כל הלינקים").
   - אם נבחרה תיקייה – להציג breadcrumb: למשל "מכירות > Q1 2025".

3.2 פעולות על תיקיות
   - יצירת תיקייה: כפתור "תיקייה חדשה" ברמת השורש; בתוך תיקייה – "תת־תיקייה" או
     קליק ימני על תיקייה → "תת־תיקייה חדשה".
   - עריכת שם: קליק על השם או "עריכה" בתפריט הקשר.
   - מחיקת תיקייה: תפריט הקשר → "מחק תיקייה". להבהיר: "הלינקים בתיקייה יישארו,
     ויופיעו תחת 'ללא תיקייה'".
   - גרירה: לגרור תיקייה לתוך תיקייה אחרת (שינוי parent_id); לגרור לינק לתיקייה
     (עדכון folder_id). אופציונלי לשלב ראשון.

3.3 לינקים
   - יצירת לינק חדש: בשמירה – שדה אופציונלי "שמור בתיקייה" (dropdown/בחירת תיקייה
     מהעץ). ברירת מחדל: ללא תיקייה.
   - העברת לינק: בתפריט הלינק (שלוש נקודות) – "העבר לתיקייה..." → בחירת תיקייה או
     "ללא תיקייה".
   - תצוגה: כשמסננים לפי תיקייה – להציג רק לינקים עם folder_id מתאים; "כל הלינקים"
     מציג את כולם (ללא סינון לפי תיקייה).

3.4 חוויית משתמש מומלצת
   - רישום מקום לשם תיקייה (למשל 2–50 תווים), הודעת שגיאה אם ריק או לא חוקי.
   - ריווח/הזחה ויזואלית בתוך עץ התיקיות לפי עומק (parent → child).
   - מונה לינקים ליד כל תיקייה (אופציונלי): "מכירות (12)".
   - Empty state: "אין לינקים בתיקייה הזו" עם CTA "צור לינק" או "העבר לינק".

3.5 ניווט וכתובות
   - אפשרות: קווריאן בכתובת, למשל /dashboard/links?folder=<uuid>, כדי שפתיחת
     תיקייה תהיה עם URL ייעודי (לשיתוף/רענון). לא חובה לשלב ראשון.

--------------------------------------------------------------------------------
4. סדר יישום מומלץ (ללא קוד – רק כיוון)
--------------------------------------------------------------------------------
   שלב 1: מיגרציה – טבלת link_folders + עמודת folder_id ב־links, RLS.
   שלב 2: API/שירותים – fetchFolders, createFolder, updateFolder, deleteFolder,
           fetchLinks(folderId?), updateLinkFolder.
   שלב 3: UI – פאנל תיקיות ב־Link Manager, תצוגת לינקים לפי תיקייה, יצירה/עריכה/מחיקה של תיקיות.
   שלב 4: שילוב ביצירת לינק – "שמור בתיקייה" ו"העבר לתיקייה" מהתפריט.
   שלב 5 (אופציונלי): גרירה, breadcrumb, מונה לינקים, קווריאן folder ב־URL.

--------------------------------------------------------------------------------
5. הערות קצרות
--------------------------------------------------------------------------------
   - הדומיין והסלאג של הלינק לא משתנים – רק ארגון בממשק.
   - Worker ו־slug validation נשארים ללא שינוי (domain+slug כרגיל).
   - תיקיות הן per-user; אין שיתוף תיקיות בין משתמשים.

================================================================================
סוף תכנון
================================================================================
